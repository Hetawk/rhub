generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "mysql"
    url      = env("DATABASE_URL")
}

enum ResourceCategory {
    CONVERTER
    DATASET
    PLAYGROUND
    API
    GUIDE
    UTILITY
    DOWNLOAD
}

enum ResourceStatus {
    DRAFT
    LIVE
    ARCHIVED
}

enum ResourceActionType {
    LINK
    INTERNAL
    TOOL
    DOCUMENTATION
}

enum ConversionStatus {
    PENDING
    PROCESSING
    COMPLETED
    FAILED
}

enum JournalType {
    ELSEVIER
    SPRINGER_NATURE
    ACM
    IEEE
    GENERIC
}

enum LaTeXQuality {
    BASIC
    STANDARD
    PROFESSIONAL
    PUBLICATION
}

model Resource {
    id        String           @id @default(cuid())
    slug      String           @unique
    title     String
    tagline   String
    summary   String
    category  ResourceCategory
    status    ResourceStatus   @default(DRAFT)
    featured  Boolean          @default(false)
    metadata  Json?
    createdAt DateTime         @default(now())
    updatedAt DateTime         @updatedAt
    actions   ResourceAction[]
}

model ResourceAction {
    id          String             @id @default(cuid())
    resourceId  String
    label       String
    description String?
    type        ResourceActionType @default(LINK)
    url         String?
    config      Json?
    order       Int                @default(0)

    resource Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

    @@index([resourceId])
}

model ConversionJob {
    id           String           @id @default(cuid())
    resourceSlug String
    inputFormat  String
    outputFormat String
    status       ConversionStatus @default(PENDING)
    sourceName   String?
    sourceSize   Int?
    entryCount   Int?
    warningCount Int?
    errorCount   Int?
    durationMs   Int?
    errorMessage String?
    metadata     Json?
    createdAt    DateTime         @default(now())
    updatedAt    DateTime         @updatedAt

    @@index([resourceSlug])
}

model ShortUrl {
    id          String    @id @default(cuid())
    originalUrl String    @db.Text
    shortCode   String    @unique
    customSlug  String?   @unique
    clicks      Int       @default(0)
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt
    expiresAt   DateTime?
    createdBy   String?
    isActive    Boolean   @default(true)

    // Analytics
    lastClickAt DateTime?
    metadata    Json?

    @@index([shortCode])
    @@index([customSlug])
    @@index([createdAt])
    @@index([isActive])
}

model DownloadableFile {
    id          String    @id @default(cuid())
    title       String
    description String?   @db.Text
    fileName    String
    filePath    String
    fileSize    Int?
    fileType    String?
    category    String?
    accessLevel String    @default("public") // public, protected, private
    password    String? // hashed password for protected files
    publicUntil DateTime? // file becomes protected after this time
    downloads   Int       @default(0)
    isActive    Boolean   @default(true)
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt

    @@index([accessLevel])
    @@index([isActive])
    @@index([category])
    @@index([publicUntil])
}

model User {
    id        String    @id @default(cuid())
    email     String    @unique
    password  String // bcrypt hashed
    name      String
    role      String    @default("admin") // admin, superadmin
    isActive  Boolean   @default(true)
    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
    sessions  Session[]

    @@index([email])
}

model Session {
    id        String   @id @default(cuid())
    userId    String
    token     String   @unique
    expiresAt DateTime
    createdAt DateTime @default(now())

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
    @@index([token])
    @@index([expiresAt])
}

// LaTeX to Word Conversion Models
model Journal {
    id             String            @id @default(cuid())
    name           String // "Elsevier Medical Image Analysis", "IEEE TMI", etc.
    type           JournalType
    documentClass  String // "elsarticle", "sn-jnl", "acmart", "IEEEtran"
    classOptions   Json? // ["preprint", "12pt"], ["pdflatex", "sn-mathphys-num"]
    bibStyle       String? // "elsarticle-num", "ACM-Reference-Format"
    requiresLogo   Boolean           @default(false)
    logoPath       String?
    yamlTemplate   String? // Path to Pandoc YAML template
    detectionRegex String? // Regex pattern for auto-detection
    description    String?           @db.Text
    publisher      String? // "Elsevier", "Springer Nature", "ACM", "IEEE"
    isActive       Boolean           @default(true)
    createdAt      DateTime          @default(now())
    updatedAt      DateTime          @updatedAt
    conversions    LaTeXConversion[]

    @@index([type])
    @@index([documentClass])
    @@index([isActive])
}

model LaTeXConversion {
    id              String           @id @default(cuid())
    journalId       String?
    detectedJournal String? // Auto-detected journal name
    manualOverride  Boolean          @default(false) // User manually selected journal
    status          ConversionStatus @default(PENDING)
    quality         LaTeXQuality     @default(STANDARD)
    inputFileName   String
    inputFileSize   Int?
    outputFileName  String?
    outputFileSize  Int?
    documentClass   String? // Detected from .tex file
    bibEntryCount   Int?
    figureCount     Int?
    tableCount      Int?
    errorMessage    String?          @db.Text
    warningMessage  String?          @db.Text
    durationMs      Int?
    metadata        Json? // Font info, packages used, compilation warnings
    createdAt       DateTime         @default(now())
    updatedAt       DateTime         @updatedAt

    journal Journal? @relation(fields: [journalId], references: [id], onDelete: SetNull)

    @@index([journalId])
    @@index([status])
    @@index([createdAt])
}

model ConversionTemplate {
    id           String      @id @default(cuid())
    name         String // "Elsevier Publication", "IEEE Journal"
    journalType  JournalType
    yamlContent  String      @db.Text // Full YAML template content
    description  String?     @db.Text
    fontSettings Json? // {"main": "Times New Roman", "size": 12}
    spacing      Float?      @default(1.5)
    margins      Json? // {"top": "1in", "bottom": "1in"}
    isDefault    Boolean     @default(false)
    createdAt    DateTime    @default(now())
    updatedAt    DateTime    @updatedAt

    @@index([journalType])
    @@index([isDefault])
}
